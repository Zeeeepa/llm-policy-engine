# Example: Redis Connection Secrets
#
# Usage:
#   1. Update values in this file (host, password, etc.)
#   2. Save as redis-secret.yaml
#   3. Seal: kubeseal -f redis-secret.yaml -w sealed-redis-secret.yaml
#   4. Apply: kubectl apply -f sealed-redis-secret.yaml

---
apiVersion: v1
kind: Secret
metadata:
  name: redis-credentials
  namespace: production
  labels:
    component: cache
    service: redis
type: Opaque
stringData:
  # Connection string format
  url: "redis://:password123@redis.prod.svc.cluster.local:6379/0"

  # Individual components
  host: "redis.prod.svc.cluster.local"
  port: "6379"
  password: "password123"
  db: "0"

  # Optional: For Redis Sentinel setup
  # sentinel-hosts: "redis-sentinel-0:26379,redis-sentinel-1:26379,redis-sentinel-2:26379"
  # sentinel-master-name: "mymaster"

---
# After sealing, the above becomes:
#
# apiVersion: bitnami.com/v1alpha1
# kind: SealedSecret
# metadata:
#   name: redis-credentials
#   namespace: production
#   labels:
#     component: cache
#     service: redis
# spec:
#   encryptionKey: sealed-secrets-key
#   template:
#     metadata:
#       name: redis-credentials
#       namespace: production
#       labels:
#         component: cache
#         service: redis
#     type: Opaque
#   encryptedData:
#     url: AgBvK8xA9K2zN4pQ2R3sT4uV5wX6yZ7aA8bC9dE0f...
#     host: AgCdL2mB7F3sO5rT6uV7wX8yZ9aB0cD1eF2gG3h...
#     port: AgEvM9nC3G4uP6sU7vW8xY9zA1bC2dE3fG4hH5i...
#     password: AgFwN0oD1pE2qF3rG4sH5tI6uJ7vK8wL9xM0y...
#     db: AgGxO1pE2qF3rG4sH5tI6uJ7vK8wL9xM0yN1zO2a...

---
# Usage in Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cache-consumer
  namespace: production
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cache-consumer
  template:
    metadata:
      labels:
        app: cache-consumer
    spec:
      containers:
      - name: app
        image: myapp/service:1.0.0
        env:
        # Option 1: Use full connection string
        - name: REDIS_URL
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: url

        # Option 2: Use individual components
        - name: REDIS_HOST
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: host
        - name: REDIS_PORT
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: port
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: password
        - name: REDIS_DB
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: db

        ports:
        - containerPort: 8080
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 20
          periodSeconds: 10

---
# Usage in StatefulSet (for cache server itself)
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: redis
  namespace: production
spec:
  serviceName: redis
  replicas: 3
  selector:
    matchLabels:
      app: redis
  template:
    metadata:
      labels:
        app: redis
    spec:
      containers:
      - name: redis
        image: redis:7-alpine
        command:
        - redis-server
        - --requirepass
        - $(REDIS_PASSWORD)
        env:
        - name: REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: redis-credentials
              key: password
        ports:
        - containerPort: 6379
          name: redis
        volumeMounts:
        - name: data
          mountPath: /data
        livenessProbe:
          exec:
            command:
            - redis-cli
            - -a
            - $(REDIS_PASSWORD)
            - ping
          initialDelaySeconds: 30
          periodSeconds: 10
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: ["ReadWriteOnce"]
      resources:
        requests:
          storage: 10Gi
